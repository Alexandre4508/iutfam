<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IUTFAM - Plateforme √âtudiante IUT R√©union</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="has-video">

<!-- UNIQUEMENT sur la page d'accueil -->
<video
  autoplay
  muted
  loop
  playsinline
  id="bgVideo"
  style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    object-fit: cover;
    z-index: -1;
  "
>
  <source src="assets/videos/IUT-TERRE-SAINTE-aceuille-video.mp4" type="video/mp4" />
</video>


    <!-- Page d'accueil -->
    <div id="landing-page" class="page active">
        <header class="landing-header">
            <div class="container">
                <img src="assets/photo/logo-iutfam.png" alt="IUTFAM Logo" class="logo-main">
                <h1>Bienvenue sur IUTFAM</h1>
              <p class="text-bg">
              La plateforme qui connecte tous les √©tudiants de l'IUT de la R√©union ! üå∏
              </p>               
                <div class="welcome-features">
                    <div class="feature-card  glass-card">
                        <h3>üó£Ô∏è Chat & Communaut√©</h3>
                        <p>√âchange avec tes camarades dans le chat g√©n√©ral ou en priv√©</p>
                    </div>
                    <div class="feature-card  glass-card">
                        <h3>üéâ √âv√©nements</h3>
                        <p>Organise et participe aux sorties √©tudiantes</p>
                    </div>
                   
                </div>


                <div class="auth-buttons">
                    <button type="button" class="btn btn--primary btn--lg" onclick="showLoginPage()">Se Connecter</button>
                    <button type="button" class="btn btn--secondary btn--lg" onclick="showRegisterPage()">S'inscrire</button>
                </div>


                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn--outline" onclick="demoLogin()">üéØ Connexion d√©mo (Marie)</button>
                </div>
            </div>
        </header>
    </div>


    <!-- Page d'inscription -->
    <div id="register-page" class="page">
        <div class="auth-container">
            <div class="auth-card">
                                <img src="assets/photo/logo-iutfam.png" alt="IUTFAM Logo" class="logo-auth">
                <h2>Cr√©er un compte IUTFAM</h2>
                <form id="register-form" onsubmit="return register(event)">
                    <div class="form-group">
                        <label class="form-label">Pr√©nom</label>
                        <input type="text" class="form-control" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nom</label>
                        <input type="text" class="form-control" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email universitaire</label>
                        <input type="email" class="form-control" id="email" placeholder="nom@iut.re ou nom@univ-reunion.fr" required>
                        <small class="form-text">Seuls les emails universitaires sont accept√©s</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">D√©partement</label>
                        <select class="form-control" id="department" required>
                            <option value="">Choisir un d√©partement</option>
                            <option value="GEA">Gestion des Entreprises et des Administrations (GEA)</option>
                            <option value="GCCD">G√©nie Civil Construction Durable (GCCD)</option>
                            <option value="GB">G√©nie Biologique (GB)</option>
                            <option value="RT">R√©seaux et T√©l√©communications (RT)</option>
                            <option value="CS">Carri√®res Sociales (CS)</option>
                            <option value="HSE">Hygi√®ne S√©curit√© Environnement (HSE)</option>
                            <option value="TC">Techniques de Commercialisation (TC)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ann√©e d'√©tude</label>
                        <select class="form-control" id="year" required>
                            <option value="">Choisir l'ann√©e</option>
                            <option value="1√®re ann√©e">1√®re ann√©e</option>
                            <option value="2√®me ann√©e">2√®me ann√©e</option>
                            <option value="3√®me ann√©e">3√®me ann√©e</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn--primary btn--full-width">S'inscrire</button>
                </form>
                <p class="auth-link">
                  D√©j√† inscrit ?
                  <!-- remplac√© par data-action -->
                  <a href="#" data-action="go-login">Se connecter</a>
                </p>
                <button type="button" class="btn btn--outline" onclick="showLandingPage()">‚Üê Retour √† l'accueil</button>
            </div>
        </div>
    </div>


    <!-- Page de connexion -->
    <div id="login-page" class="page">
      <div class="auth-container">
        <div class="auth-card">
          <img src="assets/photo/logo-iutfam.png" alt="IUTFAM" style="max-width:160px; height:auto;" />
          <h2>Se connecter √† IUTFAM</h2>


          <form id="login-form" onsubmit="return login(event)">
            <div class="form-group">
              <label class="form-label" for="login-email">Email</label>
              <input type="email" class="form-control" id="login-email" required />
            </div>


            <div class="form-group">
              <label class="form-label" for="login-password">Mot de passe</label>
              <input type="password" class="form-control" id="login-password" required />
            </div>


            <button type="submit" class="btn btn--primary btn--full-width">Se connecter</button>
          </form>


          <div class="demo-credentials">
              <h4>Comptes de d√©monstration :</h4>
              <div class="demo-account">
                  <p><strong>Email:</strong> marie.dubois@iut.re</p>
                  <p><strong>Mot de passe:</strong> password123</p>
                  <button type="button" class="btn btn--sm btn--outline" onclick="fillDemoCredentials('marie')">Remplir automatiquement</button>
              </div>
          </div>


          <p class="auth-link">
            Pas encore inscrit ?
            <!-- remplac√© par data-action -->
            <a href="#" data-action="go-register">S'inscrire</a>
          </p>
          <button type="button" class="btn btn--outline" onclick="showLandingPage()">‚Üê Retour √† l'accueil</button>
        </div>
      </div>
    </div>


    <!-- Application principale -->
    <div id="main-app" class="app">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-brand">
              <img src="assets/photo/logo-iutfam.png" alt="IUTFAM Logo" alt="IUTFAM" class="logo-nav">
                <span>IUTFAM</span>
            </div>
            <div class="nav-menu">
                <button type="button" class="nav-link active" data-section="dashboard">üè† Accueil</button>
                <button type="button" class="nav-link" data-section="chat">üí¨ Chat</button>
                <button type="button" class="nav-link" data-section="friends">üë• Amis</button>
                <button type="button" class="nav-link" data-section="events">üéâ √âv√©nements</button>
           
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span id="currentUserName">Utilisateur</span>
                      <a href="/profile" class="btn btn--sm">‚öôÔ∏è Profil</a>
    <button type="button" class="btn btn--sm btn--outline" onclick="logout()">D√©connexion</button>
</div>
            </div>
        </nav>


        <!-- Contenu principal -->
        <main class="main-content">
            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div class="container">
                    <h1>Tableau de bord</h1>
                    <p class="welcome-message">Bienvenue sur IUTFAM, <span id="dashboardUserName">Utilisateur</span>! üå∫</p>
                   
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card__body">
                                <h3>üí¨ Derniers messages (illustration) </h3>
                                <div id="recentMessages" class="recent-messages">
                                    <div class="message-preview">
                                        <strong>Marie (GEA):</strong> Quelqu'un pour la cantine ce midi ?
                                    </div>
                                    <div class="message-preview">
                                        <strong>Thomas (RT):</strong> Super soir√©e hier ! üéâ
                                    </div>
                                </div>
                                <button type="button" class="btn btn--primary btn--sm" onclick="showSection('chat')">Voir le chat</button>
                            </div>
                        </div>


                        <div class="card">
                            <div class="card__body">
                                <h3>üéâ Prochains √©v√©nements (illustration)</h3>
                                <div class="upcoming-events">
                                    <div class="event-preview">
                                        <strong>Repas cantine ensemble</strong><br>
                                        <small>15 septembre - Cantine IUT</small>
                                    </div>
                                    <div class="event-preview">
                                        <strong>Soir√©e √©tudiante au port</strong><br>
                                        <small>20 septembre - Port de Saint-Pierre</small>
                                    </div>
                                </div>
                                <button type="button" class="btn btn--primary btn--sm" onclick="showSection('events')">Voir tous les √©v√©nements</button>
                            </div>
                        </div>


                

                        <div class="card">
                            <div class="card__body">
                                <h3>üë• Activit√© (illustration) </h3>
                                <div class="activity-stats">
                                    <p><strong>127</strong> √©tudiants connect√©s</p>
                                    <p><strong>5</strong> nouveaux √©v√©nements</p>
                                    <p><strong>12</strong> messages dans votre d√©partement</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>


            <!-- Chat g√©n√©ral -->
<section id="chat" class="section">
  <div class="container">
    <h1>üí¨ Chat g√©n√©ral</h1>
    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        <!-- (tes messages d‚Äôexemple peuvent rester ou √™tre vides) -->
      </div>


      <!-- petit indicateur de frappe -->
      <div id="typingIndicator" class="message" style="display:none; opacity:.7"></div>


      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Tapez votre message..." class="form-control">
        <button type="button" onclick="sendMessage()" class="btn btn--primary">Envoyer</button>
      </div>
    </div>
  </div>
</section>




            <!-- Amis -->
           
<section id="friends" class="section">
  <div class="container">
    <h1>üë• Mes amis</h1>

    <!-- Recherche -->
    <div class="friends-search">
      <input
        id="friends-search-input"
        type="text"
        placeholder="Rechercher un √©tudiant..."
        class="form-control"
      >
      <button id="friends-search-btn" type="button" class="btn btn--primary">
        Rechercher
      </button>
    </div>

    <!-- Onglets -->
    <div class="friends-tabs">
      <button
        type="button"
        class="btn btn--secondary active"
        id="friends-tab-friends"
        data-tab="friends"
      >
        Mes amis (<span id="friends-count">0</span>)
      </button>
      <button
        type="button"
        class="btn btn--secondary"
        id="friends-tab-requests"
        data-tab="requests"
      >
        Demandes (0)
      </button>
      <button
        type="button"
        class="btn btn--secondary"
        id="friends-tab-addedme"
        data-tab="addedme"
      >
        M'ont ajout√© (<span id="friends-addedme-count">0</span>)
      </button>
    </div>

    <!-- R√©sultats de recherche -->
    <div id="friends-search-results" class="friends-list" style="margin-top:1rem;"></div>

    <!-- Mes amis -->
    <div id="friends-list" class="friends-list" data-tab-content="friends">
      <p class="menu-preview">Chargement...</p>
    </div>

    <!-- Demandes envoy√©es (pour l‚Äôinstant juste un texte) -->
    <div
      id="friends-requests"
      class="friends-list"
      data-tab-content="requests"
      style="display:none;"
    >
      <p class="menu-preview">Les demandes envoy√©es ne sont pas encore affich√©es.</p>
    </div>

    <!-- M'ont ajout√© (demandes re√ßues) -->
    <div
      id="friends-addedme"
      class="friends-list"
      data-tab-content="addedme"
      style="display:none;"
    >
      <p class="menu-preview">Chargement...</p>
    </div>
  </div>
</section>


            <!-- Groupes de classe -->
            <section id="groups" class="section">
                <div class="container">
                    <h1>üè´ Groupes de classe (illustration)</h1>
                    <div class="groups-content">
                        <div class="group-card">
                            <div class="group-header">
                                <h3>Mon d√©partement - <span id="userDepartment">GEA</span></h3>
                                <div class="group-members">24 membres</div>
                            </div>
                            <div class="group-actions">
                                <button type="button" class="btn btn--primary" onclick="openGroupChat()">üí¨ Chat du groupe</button>
                                <button type="button" class="btn btn--outline" onclick="leaveGroup()">Quitter le groupe</button>
                            </div>
                        </div>


                        <div class="other-groups">
                            <h3>Autres groupes disponibles</h3>
                            <div class="group-list">
                                <div class="group-item">
                                    <span>RT - R√©seaux et T√©l√©communications</span>
                                    <button type="button" class="btn btn--sm btn--primary">Rejoindre</button>
                                </div>
                                <div class="group-item">
                                    <span>GB - G√©nie Biologique</span>
                                    <button type="button" class="btn btn--sm btn--primary">Rejoindre</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>


            <!-- √âv√©nements -->
            <section id="events" class="section">
                <div class="container">
                    <h1>üéâ √âv√©nements </h1>
                    <div class="events-header">                        
                        <a class="nav-btn" href="/events">üéâ √âv√©nements</a>


                       <a id="create-event" class="btn" href="/events/new">+ Cr√©er un √©v√©nement</a>


                    </div>
                   
                    <div id="events-list">
                       <!-- Carte mod√®le cach√©e : sert de TEMPLATE -->
  <div class="event-card" id="event-template" style="display: none;">
    <div class="event-card-header">
      <div class="event-title" data-role="title">Titre de l‚Äô√©v√©nement</div>
      <div class="event-date" data-role="date">01 janvier 2025</div>
    </div>


    <div class="event-card-body">
      <p>üìç <span data-role="location">Lieu</span></p>
      <p>üë• <span data-role="participants">Aucun participant pour le moment</span></p>
      <p>Organis√© par <span data-role="organiser">Nom (Formation)</span></p>
    </div>


    <div class="event-card-footer">
      <button class="event-btn event-btn-primary" disabled>
        Participer
      </button>
      <a href="#" class="event-btn event-btn-secondary" data-role="details">
        D√©tails
      </a>


                            </div>
                        </div>


                        <div class="event-card">
                            <div class="event-header">
                                <h3>Soir√©e √©tudiante au port</h3>
                                <span class="event-date">20 septembre 2025</span>
                            </div>
                            <div class="event-details">
                                <p>üìç Port de Saint-Pierre</p>
                                <p>üë• 12 participants</p>
                                <p>Organis√© par Thomas (RT)</p>
                            </div>
                            <div class="event-actions">
                                <button type="button" class="btn btn--primary btn--sm">‚úÖ Participer</button>
                                <a class="btn btn--outline btn--sm" data-event="details" href="#">‚ÑπÔ∏è D√©tails</a>


                            </div>
                        </div>
                    </div>
                </div>
            </section>


    

            <!-- Board / Forum -->
            <section id="board" class="section">
                <div class="container">
                    <h1>üìã Board - Partage d'informations</h1>
                    <div class="board-header">
                        <button type="button" class="btn btn--primary" onclick="showCreatePost()">+ Nouveau post</button>
                    </div>
                   
                    <div class="board-categories">
                        <button type="button" class="btn btn--secondary active">Tout</button>
                        <button type="button" class="btn btn--secondary">üìö √âtudes</button>
                        <button type="button" class="btn btn--secondary">üè† Logement</button>
                        <button type="button" class="btn btn--secondary">üíº Emploi</button>
                        <button type="button" class="btn btn--secondary">üìù Divers</button>
                    </div>


                    <div class="posts-list">
                        <div class="post-card">
                            <div class="post-header">
                                <div class="post-author">Sarah (GB) - 2h</div>
                                <div class="post-category">üìö √âtudes</div>
                            </div>
                            <h3>Recherche partenaire pour projet environnement</h3>
                            <p>Salut ! Je cherche quelqu'un pour m'accompagner sur un projet d'analyse des eaux. Contact moi si int√©ress√© !</p>
                            <div class="post-actions">
                                <button type="button" class="btn btn--outline btn--sm">üëç 5 likes</button>
                                <button type="button" class="btn btn--outline btn--sm">üí¨ 2 commentaires</button>
                            </div>
                        </div>


                        <div class="post-card">
                            <div class="post-header">
                                <div class="post-author">Lucas (GCCD) - 5h</div>
                                <div class="post-category">üè† Logement</div>
                            </div>
                            <h3>Colocation disponible pr√®s du campus</h3>
                            <p>Une chambre libre dans ma coloc √† 5min de l'IUT. 350‚Ç¨/mois charges comprises. DM moi pour plus d'infos !</p>
                            <div class="post-actions">
                                <button type="button" class="btn btn--outline btn--sm">üëç 8 likes</button>
                                <button type="button" class="btn btn--outline btn--sm">üí¨ 6 commentaires</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>


            <!-- Menu Cantine -->
            <section id="canteen" class="section">
                <div class="container">
                    <h1>üçΩÔ∏è Menu de la cantine</h1>
                    <div class="canteen-header">
                        <button type="button" class="btn btn--primary">üì∏ Poster le menu du jour</button>
                    </div>
                   
                    <div class="menu-today">
                        <div class="card">
                            <div class="card__body">
                                <h3>Menu d'aujourd'hui - 12 septembre</h3>
                                <div class="menu-content">
                                    <p><strong>Plat principal :</strong> Cari poulet</p>
                                    <p><strong>Accompagnement :</strong> Riz blanc</p>
                                    <p><strong>L√©gumes :</strong> Rougail tomate</p>
                                    <p><strong>Dessert :</strong> Fruits de saison</p>
                                </div>
                                <div class="menu-info">
                                    <p>üí∞ Prix : 3.50‚Ç¨ √©tudiants</p>
                                    <p>üïê Horaires : 11h30 - 14h00</p>
                                </div>
                                <div class="menu-actions">
                                    <button type="button" class="btn btn--outline btn--sm">‚≠ê Noter ce menu</button>
                                    <button type="button" class="btn btn--outline btn--sm">üí¨ Commentaire</button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="menu-history">
                        <h3>Menus pr√©c√©dents</h3>
                        <div class="menu-card">
                            <div class="menu-date">11 septembre</div>
                            <div class="menu-summary">Gratin de courgettes, salade verte, yaourt</div>
                        </div>
                    </div>
                </div>
            </section>


    <!-- Page profil -->
    <div id="profile-page" class="page">
        <div class="container">
            <div class="profile-container">
                <div class="profile-header">
                    <h1>‚öôÔ∏è Mon profil</h1>
                    <button type="button" class="btn btn--outline" onclick="backToApp()">‚Üê Retour</button>
                </div>
               
                <div class="profile-content">
                    <div class="profile-form">
                        <div class="form-group">
                            <label class="form-label">Photo de profil</label>
                            <div class="profile-photo">
                                <div class="photo-placeholder">üì∏</div>
                                <button type="button" class="btn btn--secondary btn--sm">Changer</button>
                            </div>
                        </div>
                       
                        <div class="form-group">
                            <label class="form-label">Pr√©nom</label>
                            <input type="text" class="form-control" id="profileFirstName">
                        </div>
                       
                        <div class="form-group">
                            <label class="form-label">Nom</label>
                            <input type="text" class="form-control" id="profileLastName">
                        </div>
                       
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="profileEmail" readonly>
                        </div>
                       
                        <div class="form-group">
                            <label class="form-label">D√©partement</label>
                            <select class="form-control" id="profileDepartment">
                                <option value="GEA">Gestion des Entreprises et des Administrations (GEA)</option>
                                <option value="GCCD">G√©nie Civil Construction Durable (GCCD)</option>
                                <option value="GB">G√©nie Biologique (GB)</option>
                                <option value="RT">R√©seaux et T√©l√©communications (RT)</option>
                                <option value="CS">Carri√®res Sociales (CS)</option>
                                <option value="HSE">Hygi√®ne S√©curit√© Environnement (HSE)</option>
                                <option value="TC">Techniques de Commercialisation (TC)</option>
                            </select>
                        </div>
                       
                        <div class="form-group">
                            <label class="form-label">Ann√©e d'√©tude</label>
                            <select class="form-control" id="profileYear">
                                <option value="1√®re ann√©e">1√®re ann√©e</option>
                                <option value="2√®me ann√©e">2√®me ann√©e</option>
                                <option value="3√®me ann√©e">3√®me ann√©e</option>
                            </select>
                        </div>
                       
                        <div class="form-group">
                            <label class="form-label">Centres d'int√©r√™t</label>
                            <textarea class="form-control" id="profileInterests" placeholder="Sport, musique, voyages..."></textarea>
                        </div>
                       
                        <div class="profile-actions">
                            <button type="button" class="btn btn--primary" onclick="saveProfile()">Sauvegarder</button>
                            <button type="button" class="btn btn--outline" onclick="backToApp()">Annuler</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Modals -->
    <div id="privateChat" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chat priv√© avec <span id="privateChatUser"></span></h3>
                <button type="button" class="modal-close" onclick="closePrivateChat()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="chat-messages" id="privateChatMessages">
                    <div class="message">
                        <div class="message-author">Vous - 09:45</div>
                        <div class="message-content">Salut ! Comment √ßa va ?</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="privateMessageInput" placeholder="Tapez votre message..." class="form-control">
                    <button type="button"id="privateSendBtn"class="btn btn--primary">Envoyer</button>
                </div>
            </div>
        </div>
    </div>


    <script src="/legacy/app.js"></script>
    <!-- Client Socket.IO -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>


<script>
  // ====== Config locale ======
  const CHAT_ID = "GENERAL_SINGLETON"; // tu peux passer √† 'general' si tu as cr√©√© ce chat
  const USER_ID = "u_dev";             // √† remplacer plus tard par l'ID du user connect√©


  // ====== R√©f√©rences DOM ======
  const chatEl   = document.getElementById("chatMessages");
  const inputEl  = document.getElementById("messageInput");
  const typingEl = document.getElementById("typingIndicator");


  // ====== Connexion Socket.IO ======
  const socket = io(API_URL, { withCredentials: true, transports: ["websocket"] });


  socket.on("connect", () => {
    console.log("Socket.IO connect√©", socket.id);
    socket.emit("chat:join", { chatId: CHAT_ID, limit: 50 });
  });


// Historique initial (on ne traite que le chat g√©n√©ral)
socket.on("chat:history", ({ chatId, messages }) => {
  if (chatId !== CHAT_ID) return;

  chatEl.innerHTML = "";
  (messages || []).forEach(renderMessage);
  scrollToBottom();
});

// Nouveau message en temps r√©el (chat g√©n√©ral uniquement)
socket.on("message:new", (m) => {
  if (m.chatId !== CHAT_ID) return;

  renderMessage(m);
  scrollToBottom();
});


// Indicateur "est en train d‚Äô√©crire" (utilisateur r√©el)
socket.on("typing:update", ({ user, typing }) => {
  const name = user?.displayName || user?.username || user?.id || 'Anonyme';
  if (typing) {
    typingEl.textContent = `üí¨ ${name} est en train d‚Äô√©crire‚Ä¶`;
    typingEl.style.display = "block";
  } else {
    typingEl.style.display = "none";
    typingEl.textContent = "";
  }
});




  // ====== Envoi d'un message ======
  function sendMessage() {
    const content = (inputEl.value || "").trim();
    if (!content) return;
    socket.emit("message:send", { chatId: CHAT_ID, content, senderId: USER_ID });
    inputEl.value = "";
    socket.emit("typing:stop", { chatId: CHAT_ID, userId: USER_ID });
  }
  window.sendMessage = sendMessage; // n√©cessaire car appel√© via onclick= dans le HTML


  // Enter pour envoyer + typing indicators
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });
 inputEl.addEventListener("input", (e) => {
  if ((e.target.value || "").trim().length > 0) {
    socket.emit("typing:start", { chatId: CHAT_ID });
  } else {
    socket.emit("typing:stop", { chatId: CHAT_ID });
  }
});




  // ====== Helpers ======
  function renderMessage(m) {
    const wrap  = document.createElement("div");
    wrap.className = "message";


    const author = document.createElement("div");
    author.className = "message-author";
    const name = m.sender?.username || m.sender?.email || m.senderId || "Anonyme";
    const time = new Date(m.createdAt).toLocaleTimeString();
    author.textContent = `${name} - ${time}`;


    const body = document.createElement("div");
    body.className = "message-content";
    body.textContent = m.content;


    wrap.appendChild(author);
    wrap.appendChild(body);
    chatEl.appendChild(wrap);
  }


  function scrollToBottom() {
    chatEl.scrollTop = chatEl.scrollHeight;
  }
</script>
<script>
(async () => {
  const API = "http://localhost:4000";


  function formatCreator(ev) {
  const u = ev.createdBy || {};
  const name =
    u.displayName ||
    u.username ||
    u.id ||
    "Anonyme";


  // 1) si le user a directement un department
  let formation = u.department || null;


  // 2) sinon on regarde la premi√®re classe
  if (!formation && Array.isArray(u.classes) && u.classes.length > 0) {
    const cg = (u.classes[0] && u.classes[0].classGroup) || {};
    // ex : "RT-1√®re ann√©e", "GEA-2√®me ann√©e", etc.
    formation = cg.name || cg.code || cg.department || null;
  }


  return formation ? `${name} (${formation})` : name;
}




  try {
    const res = await fetch(`${API}/events`, { cache: "no-store" });
    if (!res.ok) {
      console.warn("Erreur HTTP sur /events :", res.status);
      return;
    }


    const events = await res.json();
    const container = document.getElementById("events-list");
    if (!container) return;


    if (!Array.isArray(events) || events.length === 0) {
      container.innerHTML = `
        <p class="menu-preview">Aucun √©v√©nement pour le moment. Cr√©e le premier ! üéâ</p>
      `;
      return;
    }


    const html = events.map(ev => {
      const date = ev.startsAt
        ? new Date(ev.startsAt).toLocaleDateString("fr-FR", {
            day: "2-digit",
            month: "long",
            year: "numeric"
          })
        : "Date inconnue";


      const organiser = formatCreator(ev);


      return `
        <div class="event-card">
          <div class="event-header">
            <h3>${ev.title || "√âv√©nement"}</h3>
            <span class="event-date">${date}</span>
          </div>


          <div class="event-details">
            <p>üìç ${ev.location || "Lieu inconnu"}</p>
            <p>üë• Nouvel √©v√©nement</p>
            <p>Organis√© par ${organiser}</p>
          </div>


          <div class="event-actions">
            <button type="button" class="btn btn--primary btn--sm" disabled>
              ‚úÖ Participer
            </button>
            <a class="btn btn--outline btn--sm" href="/events/${ev.id}">
              ‚ÑπÔ∏è D√©tails
            </a>
          </div>
        </div>
      `;
    }).join("");


    container.innerHTML = html;
  } catch (err) {
    console.warn("Erreur lors du chargement des √©v√©nements :", err);
  }
})();
</script>



<script>
(function () {
  const API = "http://localhost:4000";

  // ====== DOM ======
  const searchInput = document.getElementById("friends-search-input");
  const searchBtn = document.getElementById("friends-search-btn");

  const friendsTab = document.getElementById("friends-tab-friends");
  const requestsTab = document.getElementById("friends-tab-requests");
  const addedMeTab = document.getElementById("friends-tab-addedme");

  const friendsListEl = document.getElementById("friends-list");
  const requestsListEl = document.getElementById("friends-requests");
  const addedMeListEl = document.getElementById("friends-addedme");

  const friendsCountEl = document.getElementById("friends-count");
  const addedMeCountEl = document.getElementById("friends-addedme-count");

  const searchResultsEl = document.getElementById("friends-search-results");

  if (!searchInput || !friendsTab) {
    // la section amis n'est pas pr√©sente
    return;
  }

  // ====== utils ======
  function escapeHtml(str) {
    if (!str) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // force pas de cache + ajoute un petit param√®tre pour √©viter les r√©ponses en cache
  async function fetchJson(path) {
    const sep = path.includes("?") ? "&" : "?";
    const res = await fetch(API + path + sep + "_ts=" + Date.now(), {
      credentials: "include",
      cache: "no-store",
    });
    if (!res.ok) {
      throw new Error("HTTP " + res.status + " on " + path);
    }
    return res.json();
  }

  // ====== TABS ======
  function setActiveTab(tab) {
    const isFriends = tab === "friends";
    const isRequests = tab === "requests";
    const isAddedMe = tab === "addedme";

    friendsTab.classList.toggle("active", isFriends);
    requestsTab.classList.toggle("active", isRequests);
    addedMeTab.classList.toggle("active", isAddedMe);

    friendsListEl.style.display = isFriends ? "" : "none";
    requestsListEl.style.display = isRequests ? "" : "none";
    addedMeListEl.style.display = isAddedMe ? "" : "none";
  }

  friendsTab.addEventListener("click", () => setActiveTab("friends"));
  requestsTab.addEventListener("click", () => setActiveTab("requests"));
  addedMeTab.addEventListener("click", () => setActiveTab("addedme"));

  // ====== MES AMIS ======
async function loadFriends() {
  try {
    friendsListEl.innerHTML = '<p class="menu-preview">Chargement...</p>';
    const data = await fetchJson("/friends/me");

    friendsCountEl.textContent = Array.isArray(data) ? data.length : 0;

    if (!Array.isArray(data) || data.length === 0) {
      friendsListEl.innerHTML =
        '<p class="menu-preview">Tu n\'as pas encore d\'amis.</p>';
      return;
    }

    friendsListEl.innerHTML = data
      .map((f) => {
        const u = f.user || {};
        const name = u.displayName || u.username || u.email || "√âtudiant";
        const dept = u.department || "";

        return `
          <div class="friend-card">
            <div class="friend-info">
              <strong>${escapeHtml(name)}</strong>
              ${dept ? `<span>${escapeHtml(dept)}</span>` : ""}
            </div>
            <button
              type="button"
              class="btn btn--secondary btn--sm friend-message-btn"
              data-user-id="${escapeHtml(u.id)}"
              data-user-name="${escapeHtml(name)}"
            >
              Message
            </button>
          </div>
        `;
      })
      .join("");
  } catch (err) {
    console.warn("Erreur loadFriends:", err);
    friendsListEl.innerHTML =
      '<p class="menu-preview">Impossible de charger tes amis.</p>';
  }
}


  // ====== M'ONT AJOUT√â (demandes re√ßues) ======
  async function loadAddedMe() {
    try {
      addedMeListEl.innerHTML = '<p class="menu-preview">Chargement...</p>';
      const data = await fetchJson("/friends/requests");

      addedMeCountEl.textContent = Array.isArray(data) ? data.length : 0;

      if (!Array.isArray(data) || data.length === 0) {
        addedMeListEl.innerHTML =
          "<p class=\"menu-preview\">Personne ne t'a encore ajout√©.</p>";
        return;
      }

      addedMeListEl.innerHTML = data
        .map((f) => {
          const u = f.from || {};
          const name = u.displayName || u.username || u.email || "√âtudiant";
          const dept = u.department || "";

          return `
            <div class="friend-card" data-friendship-id="${escapeHtml(
              f.friendshipId
            )}">
              <div class="friend-info">
                <strong>${escapeHtml(name)}</strong>
                ${dept ? `<span>${escapeHtml(dept)}</span>` : ""}
              </div>
              <div class="friend-actions">
                <button type="button" class="btn btn--primary btn--sm" data-action="accept">Accepter</button>
                <button type="button" class="btn btn--secondary btn--sm" data-action="reject">Refuser</button>
              </div>
            </div>`;
        })
        .join("");
    } catch (err) {
      console.warn("Erreur loadAddedMe:", err);
      addedMeListEl.innerHTML =
        '<p class="menu-preview">Impossible de charger les demandes re√ßues.</p>';
    }
  }

  // clic Accepter / Refuser dans "M'ont ajout√©"
  addedMeListEl.addEventListener("click", async (event) => {
    const btn = event.target.closest("button[data-action]");
    if (!btn) return;

    const card = btn.closest(".friend-card");
    if (!card) return;

    const friendshipId = card.getAttribute("data-friendship-id");
    if (!friendshipId) return;

    const action = btn.getAttribute("data-action");
    const path =
      "/friends/" +
      encodeURIComponent(friendshipId) +
      (action === "accept" ? "/accept" : "/reject");

    try {
      await fetch(API + path + "?_ts=" + Date.now(), {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
      });
      await loadFriends();
      await loadAddedMe();
    } catch (err) {
      console.warn("Erreur accept/reject:", err);
    }
  });

  // ====== RECHERCHE (avec protection contre les r√©ponses en retard) ======
  let lastSearchToken = 0;

  async function doSearch() {
    const q = searchInput.value.trim();
    if (q.length < 2) {
      searchResultsEl.innerHTML =
        '<p class="menu-preview">Tape au moins 2 lettres.</p>';
      return;
    }

    const token = ++lastSearchToken;
    searchResultsEl.innerHTML =
      '<p class="menu-preview">Recherche en cours...</p>';

    try {
      const data = await fetchJson(
        "/friends/search?q=" + encodeURIComponent(q)
      );

      // Si une autre recherche a √©t√© lanc√©e depuis, on ignore ce r√©sultat
      if (token !== lastSearchToken) {
        return;
      }

      if (!Array.isArray(data) || data.length === 0) {
        searchResultsEl.innerHTML =
          '<p class="menu-preview">Aucun √©tudiant trouv√©.</p>';
        return;
      }

      searchResultsEl.innerHTML = data
        .map((u) => {
          const name = u.displayName || u.username || u.email || "√âtudiant";
          let actionHtml = "";
          let statusHtml = "";

          if (u.friendship) {
            if (u.friendship.status === "PENDING") {
              statusHtml =
                '<span class="friend-status">Demande en attente</span>';
            } else if (u.friendship.status === "ACCEPTED") {
              statusHtml = '<span class="friend-status">D√©j√† ami</span>';
            }
          } else {
            actionHtml =
              '<button type="button" class="btn btn--primary btn--sm" data-action="add" data-user-id="' +
              escapeHtml(u.id) +
              '">Ajouter en ami</button>';
          }

          return `
            <div class="friend-card">
              <div class="friend-info">
                <strong>${escapeHtml(name)}</strong>
              </div>
              <div class="friend-actions">
                ${actionHtml}
                ${statusHtml}
              </div>
            </div>`;
        })
        .join("");
    } catch (err) {
      console.warn("Erreur recherche amis:", err);
      searchResultsEl.innerHTML =
        '<p class="menu-preview">Erreur pendant la recherche.</p>';
    }
  }

  searchBtn.addEventListener("click", doSearch);
  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") doSearch();
  });

  // clic sur "Ajouter en ami" dans les r√©sultats
  searchResultsEl.addEventListener("click", async (event) => {
    const btn = event.target.closest("button[data-action='add']");
    if (!btn) return;

    const userId = btn.getAttribute("data-user-id");
    if (!userId) return;

    try {
      await fetch(API + "/friends/request?_ts=" + Date.now(), {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ targetUserId: userId }),
      });

      await doSearch();     // met √† jour l'√©tat "en attente"
      await loadAddedMe();  // met √† jour l'onglet "M'ont ajout√©"
    } catch (err) {
      console.warn("Erreur envoi demande ami:", err);
      alert("Impossible d'envoyer la demande pour le moment.");
    }
  });

  // ====== CHAT PRIV√â ENTRE AMIS (via le MODAL #privateChat) ======
  const privateChatModal   = document.getElementById("privateChat");
  const privateChatUserEl  = document.getElementById("privateChatUser");
  const privateMessagesEl  = document.getElementById("privateChatMessages");
  const privateInputEl     = document.getElementById("privateMessageInput");
  const privateSendBtn     = document.getElementById("privateSendBtn");

  let privateChatId = null;

  // ouvrir un chat priv√©
  async function openPrivateChat(friendId, friendName) {
    try {
      // 1) Obtenir / cr√©er l'ID de chat priv√©
      const res = await fetch(API + "/chats/private", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ targetUserId: friendId }),
      });

      if (!res.ok) {
        let msg = "Impossible d‚Äôouvrir le chat priv√©.";
        try {
          const errData = await res.json();
          if (errData?.message) msg = errData.message;
        } catch (_) {}
        console.warn("Erreur /chats/private:", res.status);
        alert(msg);
        return;
      }

      const data = await res.json();
      privateChatId = data.chatId;
      if (!privateChatId) {
        console.warn("Pas de chatId dans la r√©ponse /chats/private", data);
        alert("Impossible d‚Äôouvrir le chat priv√© (chatId manquant).");
        return;
      }

      // 2) Afficher le modal
      privateChatUserEl.textContent = friendName;
      privateChatModal.classList.remove("hidden");

      // 3) Rejoindre la room Socket.IO
      socket.emit("chat:join", { chatId: privateChatId, limit: 50 });

      // 4) Charger l'historique HTTP
      const histRes = await fetch(
        API + "/messages?chatId=" + encodeURIComponent(privateChatId) + "&limit=50",
        { credentials: "include" }
      );

      let messages = [];
      if (histRes.ok) {
        messages = await histRes.json();
      }

      privateMessagesEl.innerHTML = "";
      (Array.isArray(messages) ? messages : []).forEach(appendPrivateMessage);
      privateMessagesEl.scrollTop = privateMessagesEl.scrollHeight;
    } catch (err) {
      console.warn("openPrivateChat error:", err);
      alert("Erreur lors de l‚Äôouverture du chat priv√©.");
    }
  }

  // fermer le modal (bouton ‚úï)
  function closePrivateChat() {
    privateChatModal.classList.add("hidden");
    privateChatId = null;
    privateMessagesEl.innerHTML = "";
    privateInputEl.value = "";
  }
  window.closePrivateChat = closePrivateChat; // utilis√© dans le HTML

  // envoyer un message (bouton "Envoyer" du modal)
  async function sendPrivateMessage() {
    const text = privateInputEl.value.trim();
    if (!text || !privateChatId) return;

    socket.emit("message:send", {
      chatId: privateChatId,
      content: text,
    });

    privateInputEl.value = "";
  }

  // brancher le bouton "Envoyer"
  if (privateSendBtn) {
    privateSendBtn.addEventListener("click", () => {
      sendPrivateMessage().catch((err) =>
        console.warn("Erreur sendPrivateMessage:", err)
      );
    });
  }

  // afficher un message priv√© dans le modal
  function appendPrivateMessage(m) {
    const author = m.sender || m.author || {};
    const name =
      author.displayName || author.username || author.email || "Anonyme";

    const time = m.createdAt
      ? new Date(m.createdAt).toLocaleTimeString()
      : "";

    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `
      <div class="message-author">${escapeHtml(name)}${time ? " - " + escapeHtml(time) : ""}</div>
      <div class="message-content">${escapeHtml(m.content)}</div>
    `;
    privateMessagesEl.appendChild(div);
  }

  // r√©ception temps r√©el des messages priv√©s
  socket.on("message:new", (msg) => {
    if (!privateChatId || msg.chatId !== privateChatId) return;
    appendPrivateMessage(msg);
    privateMessagesEl.scrollTop = privateMessagesEl.scrollHeight;
  });

  // clic sur le bouton "Message" dans "Mes amis"
  document.addEventListener("click", (event) => {
    const btn = event.target.closest(".friend-message-btn");
    if (!btn) return;

    const friendId = btn.getAttribute("data-user-id");
    const friendName = btn.getAttribute("data-user-name");

    if (!friendId) return;
    openPrivateChat(friendId, friendName || "√âtudiant");
  });


  // ====== INIT ======
  setActiveTab("friends");
  loadFriends();
  loadAddedMe();
})();
</script>

</body class="has-video">
</html>
