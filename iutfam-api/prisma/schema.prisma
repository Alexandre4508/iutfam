generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String            @id @default(cuid())
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  email        String            @unique
  username     String            @unique
  passwordHash String
  displayName  String?
  avatarUrl    String?
  department   String?
  BoardPost    BoardPost[]
  canteenPosts CanteenPost[]
  chats        ChatParticipant[]
  events       Event[]           @relation("UserCreatedEvents")
  invites      EventInvite[]
  friendsB     FriendRequest[]   @relation("B")
  friendsA     FriendRequest[]   @relation("A")
  lostFound    LostFoundItem[]
  messages     Message[]
  rideShares   RideShare[]
  classes      UserClass[]
  friendshipsRequested Friendship[] @relation("friendshipsRequested")
  friendshipsReceived  Friendship[] @relation("friendshipsReceived")

}

model Friendship {
  id          String           @id @default(cuid())
  requester   User             @relation("friendshipsRequested", fields: [requesterId], references: [id])
  requesterId String
  addressee   User             @relation("friendshipsReceived", fields: [addresseeId], references: [id])
  addresseeId String
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([requesterId, addresseeId])
}


model ClassGroup {
  id    String      @id @default(cuid())
  name  String      @unique
  chats Chat[]
  users UserClass[]
}

model UserClass {
  id           String     @id @default(cuid())
  userId       String
  classGroupId String
  classGroup   ClassGroup @relation(fields: [classGroupId], references: [id])
  user         User       @relation(fields: [userId], references: [id])

  @@unique([userId, classGroupId])
}

model FriendRequest {
  id          String       @id @default(cuid())
  requesterId String
  addresseeId String
  status      FriendStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  addressee   User         @relation("B", fields: [addresseeId], references: [id])
  requester   User         @relation("A", fields: [requesterId], references: [id])

  @@unique([requesterId, addresseeId])
}

model Chat {
  id           String            @id @default(cuid())
  type         ChatType
  classId      String?
  class        ClassGroup?       @relation(fields: [classId], references: [id])
  participants ChatParticipant[]
  messages     Message[]
}

model ChatParticipant {
  id     String @id @default(cuid())
  chatId String
  userId String
  chat   Chat   @relation(fields: [chatId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([chatId, userId])
}

model Message {
  id        String   @id @default(cuid())
  chatId    String
  senderId  String
  content   String
  createdAt DateTime @default(now())
  chat      Chat     @relation(fields: [chatId], references: [id])
  sender    User     @relation(fields: [senderId], references: [id])
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?
  location    String?
  startsAt    DateTime
  endsAt      DateTime?
  published   Boolean   @default(true)

  createdById String
  createdBy   User          @relation("UserCreatedEvents", fields: [createdById], references: [id])
  invites     EventInvite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startsAt, published])
}

model EventInvite {
  id        String     @id @default(cuid())
  eventId   String
  userId    String
  status    RSVPStatus @default(PENDING)
  invitedBy String?
  event     Event      @relation(fields: [eventId], references: [id])
  user      User       @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model BoardPost {
  id        String   @id @default(cuid())
  authorId  String
  title     String
  body      String
  createdAt DateTime @default(now())
  author    User     @relation(fields: [authorId], references: [id])
}

model CanteenPost {
  id        String   @id @default(cuid())
  authorId  String
  caption   String?
  photoPath String
  createdAt DateTime @default(now())
  author    User     @relation(fields: [authorId], references: [id])
}

model LostFoundItem {
  id          String   @id @default(cuid())
  posterId    String
  title       String
  description String
  photoPath   String?
  foundLat    Float?
  foundLng    Float?
  createdAt   DateTime @default(now())
  poster      User     @relation(fields: [posterId], references: [id])
}

model RideShare {
  id        String   @id @default(cuid())
  posterId  String
  from      String
  to        String
  departAt  DateTime
  seats     Int
  note      String?
  createdAt DateTime @default(now())
  poster    User     @relation(fields: [posterId], references: [id])
}

enum FriendStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum ChatType {
  GENERAL
  PRIVATE
  CLASS
}

enum EventScope {
  ALL
  DEPARTMENT
  FRIENDS
  CUSTOM
}

enum RSVPStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model CanteenMenu {
  id           String   @id @default(cuid())
  date         DateTime @unique // le menu est lié à une date (un par jour)
  mainDish     String
  sideDish     String?
  veggies      String?
  dessert      String?
  priceStudent Decimal? @db.Decimal(5, 2)
  hoursStart   String? // "11h30"
  hoursEnd     String? // "14h00"

  ratings  CanteenRating[]
  comments CanteenComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CanteenRating {
  id        String      @id @default(cuid())
  score     Int // 1..10
  userId    String
  menuId    String
  menu      CanteenMenu @relation(fields: [menuId], references: [id])
  createdAt DateTime    @default(now())

  @@unique([menuId, userId]) // 1 note / utilisateur / menu
  @@index([menuId])
}

model CanteenComment {
  id        String      @id @default(cuid())
  text      String
  userId    String
  menuId    String
  menu      CanteenMenu @relation(fields: [menuId], references: [id])
  createdAt DateTime    @default(now())

  @@index([menuId])
}
